<!DOCTYPE html>
<html lang="ko">
  <head>
    <!-- 다양한 언어를 사용할 수 있도록 UTF-8을 사용하도록 합니다. -->
    <meta charset="UTF-8" />

    <!-- 반응형으로 동작하게 합니다. -->
    <meta title="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap과 jQuery를 포함합니다. -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
      integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- CSS library인 Bulma를 포함합니다. -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css"
    />

    <!-- 텍스트 형태로 되어있는 icon을 쓸 수 있도록 Font awesome을 포함합니다. -->
    <script
      defer
      src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"
    ></script>

    <title>마이 페이보릿 무비 | 프론트-백엔드 연결 마지막 예제!</title>

    <!-- 이 HTML 안에서 사용할 CSS를 정의합니다. -->
    <!-- .으로 시작하는 단어는 CSS class에 해당하며 .을 제외한 이름을 HTML tag에서 class="..." 형태로 사용합니다. -->
    <!-- 예: <div class="center"> -->
    <style>
      /* 전체적인 스타일 초기화 및 기본 설정 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Noto Sans KR", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      /* 헤더 섹션 스타일링 */
      .hero {
        background: linear-gradient(
          135deg,
          #ff6b6b 0%,
          #feca57 100%
        ) !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .hero::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='20' cy='20' r='4'/%3E%3C/g%3E%3C/svg%3E");
      }

      .hero-body {
        position: relative;
        z-index: 1;
        padding: 3rem 1.5rem;
      }

      .title {
        font-size: 3rem !important;
        font-weight: 800 !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem !important;
        color: white !important;
      }

      .subtitle {
        font-size: 1.25rem !important;
        color: rgba(255, 255, 255, 0.9) !important;
        font-weight: 300 !important;
      }

      /* 정렬 버튼 스타일링 */
      .sorter-box {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      .btn-group {
        display: flex;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        background: white;
      }

      .btn-group .btn {
        flex: 1;
        border: none !important;
        border-radius: 0 !important;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: white;
        color: #667eea;
        text-decoration: none;
      }

      .btn-group .btn:hover,
      .btn-group .btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
      }

      .btn-group .btn:not(:last-child) {
        border-right: 1px solid #e9ecef;
      }

      /* 휴지통 버튼 스타일링 */
      #trash-mode-box {
        margin: 1rem 0;
      }

      #trash-mode-box button {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      #trash-mode-box button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      /* 영화 카드 컨테이너 - 한 줄에 2개씩 배치 */
      .movie-list {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1rem;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
      }

      /* 영화 카드 스타일링 - 가로 레이아웃 */
      .card {
        display: flex;
        align-items: stretch;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        min-height: 250px;
      }

      .card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      /* 포스터 이미지 - 왼쪽 배치, 크기 축소 */
      .movie-poster {
        width: 160px;
        height: auto;
        min-height: 240px;
        object-fit: cover;
        flex-shrink: 0;
        transition: transform 0.3s ease;
      }

      .card:hover .movie-poster {
        transform: scale(1.05);
      }

      /* 카드 컨텐츠 영역 - 오른쪽 배치 */
      .card-content {
        display: flex;
        flex-direction: column;
        flex: 1;
        justify-content: space-between;
        padding: 1.5rem;
      }

      .card-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        flex: 1;
      }

      .movie-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        line-height: 1.2;
      }

      .movie-likes {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #e74c3c;
        font-weight: 600;
        font-size: 1rem;
      }

      .movie-likes .icon {
        color: #e74c3c;
      }

      .movie-level,
      .movie-running-time,
      .movie-date {
        font-size: 0.9rem;
        color: #7f8c8d;
        padding: 0.1rem 0;
        line-height: 1.4;
      }

      /* 카드 액션 버튼 - 하단 배치 */
      .card-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
      }

      .card-actions .btn {
        flex: 1;
        border: none;
        padding: 0.6rem 0.8rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
      }

      .card-actions .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
      }

      .card-actions .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
      }

      .card-actions .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
      }

      .card-actions .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
      }

      .card-actions .btn-success {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        color: white;
      }

      .card-actions .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
      }

      /* 반응형 디자인 */
      @media (max-width: 1200px) {
        .movie-list {
          grid-template-columns: 1fr;
          max-width: 800px;
        }

        .card {
          max-width: 100%;
        }
      }

      @media (max-width: 768px) {
        .title {
          font-size: 2rem !important;
        }

        .subtitle {
          font-size: 1rem !important;
        }

        .btn-group {
          flex-direction: column;
        }

        .btn-group .btn:not(:last-child) {
          border-right: none;
          border-bottom: 1px solid #e9ecef;
        }

        .movie-list {
          grid-template-columns: 1fr;
          padding: 1rem;
          gap: 1.5rem;
        }

        .card {
          flex-direction: column;
          align-items: center;
          text-align: center;
          min-height: auto;
        }

        .movie-poster {
          width: 100%;
          max-width: 200px;
          height: 300px;
        }

        .card-content {
          padding: 1rem;
        }

        .card-actions {
          flex-direction: column;
          gap: 0.5rem;
        }
      }

      @media (max-width: 480px) {
        .hero-body {
          padding: 2rem 1rem;
        }

        .movie-poster {
          height: 250px;
        }
      }

      /* 로딩 애니메이션 */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card {
        animation: fadeInUp 0.6s ease forwards;
      }

      /* 스크롤바 스타일링 */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      }
    </style>

    <!-- 이 HTML에서 사용할 자바스크립트를 작성합니다. -->
    <script>
      const Sort = {
        BY_LIKES: "likes",
        BY_RUNNING_TIME: "running_time",
        RELEASED_YEAR: "released_year",
      };

      let sortMode = Sort.BY_LIKES;
      let trashMode = false;

      // index.html의 로드가 완료되면 ready(...) 안에 등록된 함수가 자동으로 호출됩니다.
      // 아래는 함수에 이름을 부여하지 않고 바로 ready(...)의 매개변수로 함수를 전달하는 방식으로 로드 완료 시 호출될 함수를 등록합니다.
      $(document).ready(function () {
        // 영화 목록을 보여줍니다.
        showMovie();

        // 현재 적용되고 있는 정렬 방식의 버튼에 눌려져 보이는 효과를 줍니다.
        displaySorter();

        // 휴지통 모드에 따라 메뉴를 다르게 바꿔줍니다.
        displayTrashMode(trashMode);
      });

      function showMovie() {
        // 1. id="movie-box"로 된 태그의 내부 html 태그를 모두 삭제합니다.
        $("#movie-box").empty();

        // 2. 휴지통을 보고 있는지 여부에 따라 호출할 API를 선택합니다.
        //    휴지통이 아닐 경우 GET /api/list
        //    휴지통일 경우 GET /api/list/trash
        if (trashMode === false) {
          $.ajax({
            type: "GET",
            url: "/api/list",
            data: { sortMode: sortMode },
            success: function (response) {
              if (response["result"] !== "success") {
                alert(sortMode + " 순으로 영화 목록 받아오기 실패!");
                return;
              }
              // 3. 서버가 돌려준 stars_list를 movies라는 변수에 저장합니다.
              let movies = response["movies_list"];
              // 4. 영화 카드를 추가합니다. 이때 휴지통 여부에 따라 카드 모양이 달라지므로 휴지통 여부(=false)도 같이 전달합니다.
              addMovieCards(movies, false);
            },
          });
        } else {
          $.ajax({
            type: "GET",
            url: "/api/list/trash",
            data: { sortMode: sortMode },
            success: function (response) {
              if (response["result"] !== "success") {
                alert(sortMode + " 순으로 영화 목록 받아오기 실패!");
                return;
              }
              // 3. 서버가 돌려준 stars_list를 movies라는 변수에 저장합니다.
              let movies_trash = response["movies_trash_list"];
              // 4. 영화 카드를 추가합니다. 이때 휴지통 여부에 따라 카드 모양이 달라지므로 휴지통 여부(=false)도 같이 전달합니다.
              addMovieCards(movies_trash, true);
            },
          });
        }
      }

      function addMovieCards(movies, trashMode) {
        // for 문을 활용하여 movies 배열의 요소를 차례대로 조회합니다.
        for (let i = 0; i < movies.length; i++) {
          let movie = movies[i];

          // 1. movie[i] 요소의 title, running_time, pg_level, img_src, released_year, likes 키 값을 활용하여 값을 조회합니다.
          let id = movie["_id"];
          let title = movie["title"];
          let running_time = movie["running_time"];
          let likes = movie["likes"];
          let pg_level = movie["pg_level"];
          let img_src = movie["poster_url"];
          let released_year = movie["released_year"];

          // 3. 휴지통을 보고 있는지 여부에 따라 카드의 버튼을 다르게 설정해 줍니다.
          let cardFooterHtml = "";
          if (!trashMode) {
            cardFooterHtml = `
        <div class="card-actions">
            <button class="btn btn-primary" onclick="likeMovie('${title}')">
                <i class="fas fa-thumbs-up"></i>좋아요
            </button>
            <button class="btn btn-danger" onclick="trashMovie('${title}')">
                <i class="fas fa-trash"></i>휴지통으로
            </button>
        </div>
      `;
          } else {
            cardFooterHtml = `
        <div class="card-actions">
            <button class="btn btn-success" onclick="restoreMovie('${title}')">
                <i class="fas fa-undo"></i>복구하기
            </button>
            <button class="btn btn-danger" onclick="deleteMovie('${title}')">
                <i class="fas fa-times"></i>영구삭제
            </button>
        </div>
      `;
          }

          // 4. #movie-box에 생성된 HTML 을 붙입니다.
          $("#movie-box").append(`
      <div class="card">
        <img src="${img_src}" class="movie-poster"/>
        <div class="card-content">
          <div class="card-info">
            <span class="movie-title">${title}</span>
            <div class="movie-likes">
              <span class="icon"><i class="fas fa-thumbs-up"></i></span>
              <span>${likes}</span>
            </div>
            <span class="movie-level">상영 등급 : ${pg_level}</span>
            <span class="movie-running-time">상영 시간 : ${running_time} 분</span>
            <span class="movie-date">상영 연도 : ${released_year} 년</span>
          </div>
          ${cardFooterHtml}
        </div>
      </div>
    `);
        }
      }

      ///////////////////////////////////////////////////////////////////////////////
      // 주의: 아래 like movie는 임의의 영화에 좋아요가 표시됩니다.
      // 이 구현을 선택한 무비에 좋아요를 넣는 것으로 수정하셔야 됩니다. (함수 매개변수 및 함수 구현 모두)
      function likeMovie(title) {
        $.ajax({
          type: "POST",
          url: "/api/like",
          data: { movie_title: title },
          success: function (response) {
            if (response["result"] === "success") {
              // 2. '좋아요 완료!' 경고창을 띄웁니다.
              alert("좋아요 완료!");
              // 3. 변경된 정보를 반영하기 위해 새로고침합니다.
              showMovie();
            } else {
              alert("좋아요 실패ㅠㅠ");
            }
          },
        });
      }

      function trashMovie(title) {
        $.ajax({
          type: "POST",
          url: "/api/trash",
          data: { movie_title: title },
          success: function (response) {
            if (response["result"] === "success") {
              alert("휴지통 보내기 완료!");
              showMovie();
            } else {
              alert("휴지통 보내기 실패ㅠㅠ");
            }
          },
        });
      }

      function restoreMovie(title) {
        $.ajax({
          type: "POST",
          url: "/api/trash/restore",
          data: { movie_title: title },
          success: function (response) {
            if (response["result"] === "success") {
              alert("복구 완료!");
              showMovie();
            } else {
              alert("복구 실패ㅠㅠ");
            }
          },
        });
      }

      function deleteMovie(title) {
        $.ajax({
          type: "POST",
          url: "/api/trash/delete",
          data: { movie_title: title },
          success: function (response) {
            if (response["result"] === "success") {
              alert("삭제 완료!");
              showMovie();
            } else {
              alert("삭제 실패ㅠㅠ");
            }
          },
        });
      }

      // 정렬 기준 버튼을 클릭하면 호출됨
      function changeSorter(newMode) {
        if (sortMode === newMode) {
          return;
        }

        sortMode = newMode;
        displaySorter();
        showMovie();
      }

      // 정렬 기준에 따라 해당 버튼만 활성화시키고 다른 버튼은 비활성화 시킴
      function displaySorter() {
        document.getElementById("sorter-likes").classList.remove("active");
        document
          .getElementById("sorter-running-time")
          .classList.remove("active");
        document
          .getElementById("sorter-released-year")
          .classList.remove("active");

        if (sortMode === Sort.BY_LIKES) {
          document.getElementById("sorter-likes").classList.add("active");
        } else if (sortMode === Sort.BY_RUNNING_TIME) {
          document
            .getElementById("sorter-running-time")
            .classList.add("active");
        } else if (sortMode === Sort.RELEASED_YEAR) {
          document
            .getElementById("sorter-released-year")
            .classList.add("active");
        }
      }

      function displayTrashMode(trashMode) {
        $("#trash-mode-box").empty(); // 기존 버튼 제거
        if (trashMode === true) {
          $("#trash-mode-box").append(
            `<button onclick="toggleTrashMode()">휴지통 나가기</button>`
          );
        } else {
          $("#trash-mode-box").append(
            `<button onclick="toggleTrashMode()">휴지통 보기</button>`
          );
        }
      }

      function toggleTrashMode() {
        trashMode = !trashMode;
        displayTrashMode(trashMode);
        showMovie();
      }
    </script>
  </head>

  <!-- HTML 본문에 해당합니다. -->
  <!-- HTML 태그를 이용해서 layout을 대략적으로 잡아두고, -->
  <!-- 위에 정의된 자바스크립트를 통해 동적으로 데이터를 조작해 최종 HTML 이 만들어집니다. -->
  <body>
    <!-- 제목 부분 -->
    <section class="hero is-warning">
      <div class="hero-body">
        <div class="container center">
          <h1 class="title">마이 페이보릿 무비😆</h1>
          <h2 class="subtitle">순위를 매겨봅시다</h2>
        </div>
      </div>
    </section>

    <!-- 정렬 옵션 부분 -->
    <!-- *주의* 아래 내용 중 id="sorter-likes", id="sorter-running-time", id="sorter-released-year"은 삭제하면 안 됩니다. -->
    <div class="mx-auto sorter-box">
      <div class="btn-group m-3 mx-auto w-100">
        <a
          href="#"
          class="btn btn-primary"
          id="sorter-likes"
          onclick="changeSorter('likes')"
          >좋아요 순으로 정렬</a
        >
        <a
          href="#"
          class="btn btn-primary"
          id="sorter-running-time"
          onclick="changeSorter('running_time')"
          >누적관객 수 순으로 정렬</a
        >
        <a
          href="#"
          class="btn btn-primary"
          id="sorter-released-year"
          onclick="changeSorter('released_year')"
          >개봉일 순으로 정렬</a
        >
      </div>
    </div>

    <!-- "휴지통 보기" 부분 -->
    <!-- *주의* 아래 내용 중 id="trash-mode-box" 은 삭제하면 안 됩니다. -->
    <div class="mx-auto sorter-box">
      <span class="d-flex justify-content-end">
        <div id="trash-mode-box">
          <!-- 자바스크립트가 이 사이에 trash mode에 따라 HTML element를 생성해서 삽입합니다. -->
        </div>
      </span>
    </div>

    <!-- 동적으로 영화 목록이 들어갈 부분 -->
    <!-- *주의* 아래 내용 중 id="movie-box"은 삭제하면 안 됩니다. -->
    <div class="movie-list" id="movie-box">
      <!-- 자바스크립트가 이 사이에 HTML element를 생성해서 삽입합니다. -->
    </div>
  </body>
</html>
